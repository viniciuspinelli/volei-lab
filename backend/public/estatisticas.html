<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Estat√≠sticas - Pagou-Jogou Volei Clube</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #071226 0%, #0a1f3a 100%);
      color: #eaf6ff;
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid rgba(52, 211, 153, 0.3);
    }
    .logo-section {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .logo {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #34d399, #10b981);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      font-weight: 700;
      color: #071226;
    }
    h1 {
      font-size: 28px;
      color: #34d399;
    }
    .nav-links {
      display: flex;
      gap: 15px;
    }
    .nav-links a {
      color: #eaf6ff;
      text-decoration: none;
      padding: 10px 15px;
      border-radius: 6px;
      transition: background 0.3s;
    }
    .nav-links a:hover {
      background: rgba(52, 211, 153, 0.2);
    }
    .nav-links a.active {
      background: linear-gradient(90deg, #34d399, #10b981);
      color: #071226;
      font-weight: 600;
    }
    .resumo-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }
    .card {
      background: rgba(11, 37, 64, 0.6);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid rgba(52, 211, 153, 0.2);
    }
    .card-title {
      font-size: 14px;
      color: #a0d8c5;
      text-transform: uppercase;
      font-weight: 600;
      margin-bottom: 10px;
    }
    .card-value {
      font-size: 28px;
      font-weight: 700;
      color: #34d399;
    }
    .filtros {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .filtro-btn {
      padding: 8px 16px;
      border: 1px solid rgba(52, 211, 153, 0.3);
      background: transparent;
      color: #eaf6ff;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s;
      font-family: 'Inter', sans-serif;
    }
    .filtro-btn:hover {
      background: rgba(52, 211, 153, 0.1);
    }
    .filtro-btn.active {
      background: linear-gradient(90deg, #34d399, #10b981);
      color: #071226;
      border-color: #34d399;
    }
    .ranking-section {
      margin-top: 30px;
    }
    .ranking-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 15px;
      color: #34d399;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(11, 37, 64, 0.6);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(52, 211, 153, 0.2);
    }
    thead {
      background: rgba(52, 211, 153, 0.1);
      border-bottom: 1px solid rgba(52, 211, 153, 0.2);
    }
    th {
      padding: 15px;
      text-align: left;
      font-weight: 600;
      color: #34d399;
      font-size: 13px;
      text-transform: uppercase;
    }
    td {
      padding: 12px 15px;
      border-bottom: 1px solid rgba(52, 211, 153, 0.1);
      color: #eaf6ff;
    }
    tr:hover {
      background: rgba(52, 211, 153, 0.05);
    }
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }
    .badge-mensalista {
      background: #3b82f6;
      color: #fff;
    }
    .badge-avulso {
      background: #ffd54f;
      color: #000;
    }
    .badge-feminino {
      background: rgba(236, 100, 155, 0.3);
      color: #ff6b9d;
    }
    .badge-masculino {
      background: rgba(59, 130, 246, 0.3);
      color: #60a5fa;
    }
    .ranking-position {
      font-size: 16px;
      font-weight: 700;
      color: #34d399;
      width: 30px;
    }
    .ranking-position.top1 { color: #fbbf24; }
    .ranking-position.top2 { color: #d1d5db; }
    .ranking-position.top3 { color: #f97316; }
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #a0d8c5;
    }
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }
    .login-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .login-modal.ativo { display: flex; }
    .login-box {
      background: rgba(11, 37, 64, 0.95);
      border-radius: 12px;
      padding: 30px;
      max-width: 350px;
      width: 90%;
      border: 1px solid rgba(52, 211, 153, 0.3);
    }
    .login-box h3 {
      color: #34d399;
      margin-bottom: 20px;
    }
    .login-box input {
      width: 100%;
      padding: 12px;
      border: 1px solid rgba(52, 211, 153, 0.3);
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.3);
      color: #eaf6ff;
      font-size: 14px;
      margin-bottom: 12px;
    }
    .login-box button {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
    }
    .login-box .btn-login {
      background: linear-gradient(90deg, #34d399, #10b981);
      color: #071226;
      margin-bottom: 8px;
    }
    .login-box .btn-cancelar {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #a0d8c5;
    }
    .login-erro {
      color: #ef4444;
      font-size: 13px;
      margin-bottom: 12px;
      display: none;
    }
    .admin-badge {
      background: rgba(52, 211, 153, 0.2);
      color: #34d399;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 12px;
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <!-- Modal de Login -->
  <div class="login-modal" id="loginModal">
    <div class="login-box">
      <h3>üîê Login Admin</h3>
      <div class="login-erro" id="loginErro"></div>
      <input type="text" id="loginUsuario" placeholder="Usu√°rio">
      <input type="password" id="loginSenha" placeholder="Senha">
      <button class="btn-login" onclick="fazerLogin()">Entrar</button>
      <button class="btn-cancelar" onclick="fecharLogin()">Cancelar</button>
    </div>
  </div>

  <div class="container">
    <header>
      <div class="logo-section">
        <div class="logo">‚ö°</div>
        <div>
          <h1>Estat√≠sticas</h1>
          <p style="font-size: 12px; color: #a0d8c5;">Ranking de Frequ√™ncia</p>
        </div>
      </div>
      <nav class="nav-links">
        <a href="index.html">Voltar</a>
        <a href="#" onclick="abrirLogin(event)" id="btnLogin" style="background: rgba(52, 211, 153, 0.2); color: #34d399;">üîê Admin</a>
        <a href="#" onclick="fazerLogout(event)" id="btnLogout" style="background: rgba(239, 68, 68, 0.2); color: #ef4444; display: none;">Sair</a>
        <a href="#" onclick="ativarModoTeste(event)" style="background: rgba(255, 213, 79, 0.2); color: #ffd54f; display: none;" id="btnModoTeste">üß™ Teste</a>
      </nav>
    </header>

    <div class="resumo-section" id="resumoSection">
      <div class="card">
        <div class="card-title">Total de Confirma√ß√µes</div>
        <div class="card-value" id="totalConfirmacoes">0</div>
      </div>
      <div class="card">
        <div class="card-title">Pessoas √önicas</div>
        <div class="card-value" id="pessoasUnicas">0</div>
      </div>
      <div class="card">
        <div class="card-title">M√©dia por Pessoa</div>
        <div class="card-value" id="mediaConfirmacoes">0</div>
      </div>
    </div>

    <div class="ranking-section">
      <div class="filtros">
        <button class="filtro-btn active" onclick="filtrarPor('todos')">Todos</button>
        <button class="filtro-btn" onclick="filtrarPor('feminino')">üë© Feminino</button>
        <button class="filtro-btn" onclick="filtrarPor('masculino')">üë® Masculino</button>
        <button class="filtro-btn" onclick="filtrarPor('mensalista')">üéüÔ∏è Mensalista</button>
        <button class="filtro-btn" onclick="filtrarPor('avulso')">üíµ Avulso</button>
      </div>

      <div class="ranking-title">Ranking de Frequ√™ncia</div>
      
      <table id="rankingTable">
        <thead>
          <tr>
            <th style="width: 40px;">#</th>
            <th>Nome</th>
            <th>Tipo</th>
            <th>G√™nero</th>
            <th style="text-align: right;">Vezes</th>
            <th style="text-align: right;">√öltima</th>
            <th style="width: 50px;"></th>
          </tr>
        </thead>
        <tbody id="rankingBody">
          <tr>
            <td colspan="6" class="empty-state">
              <div class="empty-state-icon">üìä</div>
              <p>Carregando estat√≠sticas...</p>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    let statsData = null;
    let filtroAtual = 'todos';
    let modoTeste = false;
    let adminToken = localStorage.getItem('adminToken') || null;
    let isAdmin = false;

    // Fun√ß√µes de Login
    function abrirLogin(e) {
      e.preventDefault();
      document.getElementById('loginModal').classList.add('ativo');
      document.getElementById('loginUsuario').focus();
    }

    function fecharLogin() {
      document.getElementById('loginModal').classList.remove('ativo');
      document.getElementById('loginErro').style.display = 'none';
      document.getElementById('loginUsuario').value = '';
      document.getElementById('loginSenha').value = '';
    }

    async function fazerLogin() {
      const usuario = document.getElementById('loginUsuario').value.trim();
      const senha = document.getElementById('loginSenha').value;
      const erroEl = document.getElementById('loginErro');
      
      if (!usuario || !senha) {
        erroEl.textContent = 'Preencha usu√°rio e senha.';
        erroEl.style.display = 'block';
        return;
      }
      
      try {
        const res = await fetch('/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ usuario, senha })
        });
        const data = await res.json();
        
        if (data.sucesso && data.token) {
          adminToken = data.token;
          localStorage.setItem('adminToken', adminToken);
          isAdmin = true;
          atualizarUIAdmin();
          fecharLogin();
          renderizarRanking();
        } else {
          erroEl.textContent = data.erro || 'Erro ao fazer login.';
          erroEl.style.display = 'block';
        }
      } catch (err) {
        erroEl.textContent = 'Erro de conex√£o.';
        erroEl.style.display = 'block';
      }
    }

    async function fazerLogout(e) {
      e.preventDefault();
      try {
        await fetch('/logout', {
          method: 'POST',
          headers: { 'X-Admin-Token': adminToken }
        });
      } catch (err) {}
      adminToken = null;
      isAdmin = false;
      localStorage.removeItem('adminToken');
      atualizarUIAdmin();
      renderizarRanking();
    }

    async function verificarToken() {
      if (!adminToken) return;
      try {
        const res = await fetch('/verificar-token', {
          headers: { 'X-Admin-Token': adminToken }
        });
        const data = await res.json();
        isAdmin = data.valido;
        if (!isAdmin) {
          adminToken = null;
          localStorage.removeItem('adminToken');
        }
        atualizarUIAdmin();
      } catch (err) {
        isAdmin = false;
      }
    }

    function atualizarUIAdmin() {
      document.getElementById('btnLogin').style.display = isAdmin ? 'none' : 'block';
      document.getElementById('btnLogout').style.display = isAdmin ? 'block' : 'none';
    }

    // Enter para fazer login
    document.getElementById('loginSenha').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') fazerLogin();
    });

    // Dados de teste
    const nomesFemininos = [
      'Ana', 'Bruna', 'Carla', 'Diana', 'Estela', 'Fernanda', 'Gabriela', 'Helena'
    ];
    const nomesMasculinos = [
      'Andr√©', 'Bruno', 'Carlos', 'Daniel', 'Eduardo', 'Felipe', 'Gabriel', 'Henry',
      'Igor', 'Jo√£o', 'Kevin', 'Lucas', 'Marcos', 'Neto', 'Ot√°vio', 'Pedro'
    ];
    const tipos = ['mensalista', 'avulso'];

    function gerarDadosTeste() {
      const mapa = {};
      
      nomesFemininos.forEach(nome => {
        const freq = Math.floor(Math.random() * 15) + 1;
        const tipo = tipos[Math.floor(Math.random() * tipos.length)];
        const dias = Math.floor(Math.random() * 120);
        const data = new Date();
        data.setDate(data.getDate() - dias);
        mapa[nome] = { nome, genero: 'feminino', tipo, total_confirmacoes: freq, ultima_confirmacao: data.toISOString() };
      });
      
      nomesMasculinos.forEach(nome => {
        const freq = Math.floor(Math.random() * 20) + 1;
        const tipo = tipos[Math.floor(Math.random() * tipos.length)];
        const dias = Math.floor(Math.random() * 120);
        const data = new Date();
        data.setDate(data.getDate() - dias);
        mapa[nome] = { nome, genero: 'masculino', tipo, total_confirmacoes: freq, ultima_confirmacao: data.toISOString() };
      });
      
      const ranking = Object.values(mapa).sort((a, b) => b.total_confirmacoes - a.total_confirmacoes);
      const total = ranking.reduce((sum, r) => sum + r.total_confirmacoes, 0);
      const porGenero = {};
      ranking.forEach(r => {
        if (!porGenero[r.genero]) porGenero[r.genero] = { total: 0, pessoas: 0 };
        porGenero[r.genero].total += r.total_confirmacoes;
        porGenero[r.genero].pessoas += 1;
      });
      
      return {
        ranking,
        resumo: { totalConfirmacoes: total, pessoasUnicas: ranking.length, mediaConfirmacoes: (total / ranking.length).toFixed(2) },
        porGenero
      };
    }

    function ativarModoTeste(e) {
      e.preventDefault();
      modoTeste = true;
      document.getElementById('btnModoTeste').style.display = 'none';
      document.getElementById('rankingBody').innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #ffd54f;"><strong>üß™ MODO TESTE ATIVADO</strong></td></tr>';
      statsData = gerarDadosTeste();
      atualizarResumo();
      renderizarRanking();
    }

    async function carregarEstatisticas() {
      try {
        const res = await fetch('/estatisticas');
        statsData = await res.json();
        atualizarResumo();
        renderizarRanking();
      } catch (err) {
        console.error('Erro ao carregar estat√≠sticas:', err);
        document.getElementById('rankingBody').innerHTML = `
          <tr>
            <td colspan="6" class="empty-state">
              <div class="empty-state-icon">‚ùå</div>
              <p>Erro ao carregar dados</p>
              <p style="font-size: 12px; margin-top: 10px;">Dados reais n√£o dispon√≠veis. <a href="#" onclick="ativarModoTeste(event)" style="color: #34d399;">Use modo de teste</a> para visualizar exemplo.</p>
            </td>
          </tr>
        `;
        document.getElementById('btnModoTeste').style.display = 'block';
      }
    }

    function atualizarResumo() {
      const { totalConfirmacoes, pessoasUnicas, mediaConfirmacoes } = statsData.resumo;
      document.getElementById('totalConfirmacoes').textContent = totalConfirmacoes;
      document.getElementById('pessoasUnicas').textContent = pessoasUnicas;
      document.getElementById('mediaConfirmacoes').textContent = mediaConfirmacoes;
    }

    function renderizarRanking() {
      let dados = statsData.ranking;

      if (filtroAtual === 'feminino') {
        dados = dados.filter(d => d.genero === 'feminino');
      } else if (filtroAtual === 'masculino') {
        dados = dados.filter(d => d.genero === 'masculino');
      } else if (filtroAtual === 'mensalista') {
        dados = dados.filter(d => d.tipo === 'mensalista');
      } else if (filtroAtual === 'avulso') {
        dados = dados.filter(d => d.tipo === 'avulso');
      }

      const tbody = document.getElementById('rankingBody');
      
      if (dados.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="empty-state">
              <div class="empty-state-icon">üì≠</div>
              <p>Nenhum dado para este filtro</p>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = dados.map((d, idx) => {
        const posicao = idx + 1;
        const dataObj = new Date(d.ultima_confirmacao);
        const dataFormatada = dataObj.toLocaleDateString('pt-BR');
        
        let posicaoClass = '';
        if (posicao === 1) posicaoClass = 'top1';
        else if (posicao === 2) posicaoClass = 'top2';
        else if (posicao === 3) posicaoClass = 'top3';

        const btnRemover = isAdmin ? `
            <td style="text-align: center;">
              <button onclick="removerUsuario('${d.nome.replace(/'/g, "\\'")}')" style="background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.4); color: #ef4444; width: 32px; height: 32px; border-radius: 6px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center;" title="Remover ${d.nome}">‚úï</button>
            </td>
        ` : '<td></td>';

        return `
          <tr>
            <td class="ranking-position ${posicaoClass}">üèÜ ${posicao}</td>
            <td><strong>${d.nome}</strong></td>
            <td>
              <span class="badge ${d.tipo === 'avulso' ? 'badge-avulso' : 'badge-mensalista'}">
                ${d.tipo}
              </span>
            </td>
            <td>
              <span class="badge badge-${d.genero}">
                ${d.genero}
              </span>
            </td>
            <td style="text-align: right; font-weight: 700; color: #34d399;">${d.total_confirmacoes}</td>
            <td style="text-align: right; font-size: 12px; color: #a0d8c5;">${dataFormatada}</td>
            ${btnRemover}
          </tr>
        `;
      }).join('');
    }

    function filtrarPor(filtro) {
      filtroAtual = filtro;
      
      document.querySelectorAll('.filtro-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');

      renderizarRanking();
    }

    async function removerUsuario(nome) {
      if (!isAdmin) {
        alert('Voc√™ precisa estar logado como admin para remover usu√°rios.');
        return;
      }
      if (!confirm(`Tem certeza que deseja remover "${nome}" das estat√≠sticas?\n\nIsso remover√° TODAS as confirma√ß√µes deste usu√°rio.`)) {
        return;
      }
      try {
        const res = await fetch('/estatisticas/' + encodeURIComponent(nome), { 
          method: 'DELETE',
          headers: { 'X-Admin-Token': adminToken }
        });
        const data = await res.json();
        if (data.sucesso) {
          alert(`Usu√°rio "${nome}" removido com sucesso! (${data.removidos} confirma√ß√µes removidas)`);
          carregarEstatisticas();
        } else {
          alert('Erro: ' + (data.erro || 'N√£o foi poss√≠vel remover.'));
        }
      } catch (err) {
        alert('Erro ao remover usu√°rio.');
        console.error(err);
      }
    }

    // Inicializa√ß√£o
    verificarToken();
    carregarEstatisticas();
    setInterval(carregarEstatisticas, 10000);
  </script>
</body>
</html>