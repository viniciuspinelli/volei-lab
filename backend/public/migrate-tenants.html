<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Migra√ß√£o Tenants</title>
  <style>
    body { 
      font-family: monospace; 
      background: #000; 
      color: #0f0; 
      padding: 20px; 
    }
    button { 
      background: #0f0; 
      color: #000; 
      padding: 15px 30px; 
      border: none; 
      font-size: 16px; 
      cursor: pointer; 
    }
    #logs { 
      background: #111; 
      padding: 20px; 
      height: 400px; 
      overflow-y: auto; 
      white-space: pre-wrap; 
      border: 1px solid #0f0; 
    }
  </style>
</head>
<body>
  <h1>üîß Migra√ß√£o da Tabela Tenants</h1>
  <button onclick="executarMigracao()">üöÄ Executar Migra√ß√£o</button>
  <div id="logs">Aguardando...</div>

  <script>
    async function adicionarLog(msg) {
      const logs = document.getElementById('logs');
      logs.textContent += `${new Date().toLocaleTimeString()}: ${msg}\n`;
      logs.scrollTop = logs.scrollHeight;
    }

    async function executarMigracao() {
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = 'Executando...';
      
      adicionarLog('Iniciando migra√ß√£o da tabela tenants...');
      
      try {
        // 1. Adicionar colunas se n√£o existirem
        const cols = ['created_at', 'updated_at', 'subscription_plan', 'subscription_expires', 'mercadopago_payment_id'];
        
        for (const col of cols) {
          adicionarLog(`Verificando coluna ${col}...`);
          const res = await fetch('/api/migrate/add-column', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ column: col })
          });
          adicionarLog(`Coluna ${col}: ${res.ok ? '‚úÖ OK' : '‚ö†Ô∏è ' + await res.text()}`);
        }
        
        // 2. Criar constraint de status
        adicionarLog('Criando constraint de status...');
        const constraintRes = await fetch('/api/migrate/add-constraint');
        adicionarLog(`Constraint: ${constraintRes.ok ? '‚úÖ OK' : '‚ö†Ô∏è ' + await constraintRes.text()}`);
        
        // 3. Criar tenant padr√£o se n√£o existir
        adicionarLog('Criando tenant padr√£o...');
        const tenantRes = await fetch('/api/migrate/create-default-tenant');
        adicionarLog(`Tenant padr√£o: ${tenantRes.ok ? '‚úÖ OK' : '‚ö†Ô∏è ' + await tenantRes.text()}`);
        
        adicionarLog('üéâ MIGRA√á√ÉO CONCLU√çDA COM SUCESSO!');
        adicionarLog('üîÑ Aguarde 10s e recarregue o painel admin');
        
      } catch (error) {
        adicionarLog(`‚ùå Erro: ${error.message}`);
      }
      
      btn.disabled = false;
      btn.textContent = 'üöÄ Executar Migra√ß√£o';
    }
  </script>
</body>
</html>
