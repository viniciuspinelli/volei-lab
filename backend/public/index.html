<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pagou-Jogou V√¥lei Clube</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #000000;
      --bg-secondary: #111111;
      --bg-card: #1a1a1a;
      --text-primary: #ffffff;
      --text-muted: #888888;
      --accent: #ff6b00;
      --accent-light: #ff8533;
      --accent-dark: #cc5500;
      --danger: #ef4444;
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
      --spacing-xl: 32px;
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 16px;
      --sidebar-width: 240px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: Inter, system-ui, Arial, sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }
    
    .app-container { display: flex; min-height: 100vh; }
    .sidebar { width: var(--sidebar-width); background: var(--bg-secondary); border-right: 1px solid rgba(255,255,255,0.05); padding: var(--spacing-lg); display: flex; flex-direction: column; position: fixed; height: 100vh; left: 0; top: 0; }
    .sidebar-logo { display: flex; align-items: baseline; gap: 4px; font-weight: 700; letter-spacing: 1px; font-size: 18px; margin-bottom: var(--spacing-xl); padding-bottom: var(--spacing-lg); border-bottom: 1px solid rgba(255,255,255,0.05); }
    .sidebar-logo .part1 { color: var(--text-primary); }
    .sidebar-logo .part2 { color: var(--accent); }
    .sidebar-nav { display: flex; flex-direction: column; gap: var(--spacing-sm); flex: 1; }
    .nav-item { display: flex; align-items: center; gap: var(--spacing-md); padding: 14px 16px; border-radius: var(--radius-md); color: var(--text-muted); text-decoration: none; font-size: 14px; font-weight: 500; transition: all 0.2s; cursor: pointer; border: none; background: transparent; width: 100%; text-align: left; }
    .nav-item:hover { background: rgba(255, 107, 0, 0.1); color: var(--text-primary); }
    .nav-item.active { background: rgba(255, 107, 0, 0.15); color: var(--accent); border-left: 3px solid var(--accent); }
    .sidebar-admin { border-top: 1px solid rgba(255,255,255,0.05); padding-top: var(--spacing-md); margin-top: auto; }
  
    .main-content { flex: 1; margin-left: var(--sidebar-width); padding: var(--spacing-xl); min-height: 100vh; }
    .page { display: none; max-width: 800px; margin: 0 auto; }
    .page.active { display: block; }
    .page-header { margin-bottom: var(--spacing-xl); }
    .page-title { font-size: 28px; font-weight: 700; color: var(--text-primary); margin-bottom: var(--spacing-xs); }
    .page-subtitle { color: var(--text-muted); font-size: 14px; }
    .user-info { margin-top: 8px; font-size: 12px; color: var(--accent); font-weight: 600; }
    
    .card { background: var(--bg-card); border-radius: var(--radius-lg); padding: var(--spacing-lg); margin-bottom: var(--spacing-lg); border: 1px solid rgba(255,255,255,0.05); }
    .card-title { font-size: 16px; font-weight: 600; margin-bottom: var(--spacing-md); display: flex; align-items: center; gap: var(--spacing-sm); }
    .form-group { margin-bottom: var(--spacing-md); }
    .form-label { display: block; font-size: 13px; color: var(--text-muted); margin-bottom: var(--spacing-xs); }
    input, select { width: 100%; height: 48px; padding: 12px 14px; border-radius: var(--radius-md); border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.03); color: var(--text-primary); font-size: 15px; transition: border-color 0.2s; }
    input:focus, select:focus { outline: none; border-color: var(--accent); }
    
    .btn { height: 48px; padding: 12px 20px; border-radius: var(--radius-md); border: none; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: var(--spacing-sm); }
    .btn-primary { background: linear-gradient(135deg, var(--accent), var(--accent-dark)); color: #000; }
    .btn-primary:hover { background: linear-gradient(135deg, var(--accent-light), var(--accent)); transform: translateY(-1px); }
    .btn-secondary { background: rgba(255,107,0,0.15); border: 1px solid rgba(255,107,0,0.3); color: var(--accent); }
    .btn-secondary:hover { background: rgba(255,107,0,0.25); }
    .btn-danger { background: rgba(239,68,68,0.15); border: 1px solid rgba(239,68,68,0.3); color: var(--danger); }
    .btn-danger:hover { background: rgba(239,68,68,0.25); }
    .btn-block { width: 100%; }
    
    .contador-badge { background: rgba(255,107,0,0.2); color: var(--accent); padding: 4px 10px; border-radius: var(--radius-sm); font-size: 13px; font-weight: 600; }
    .lista-confirmados { list-style: none; }
    .lista-item { display: flex; align-items: center; justify-content: space-between; padding: 14px 12px; border-bottom: 1px solid rgba(255,255,255,0.03); transition: background 0.2s; }
    .lista-item:hover { background: rgba(255,255,255,0.02); }
    .lista-item.avulso { border-left: 3px solid var(--accent); background: rgba(255,107,0,0.03); }
    .lista-item .info { display: flex; align-items: center; gap: var(--spacing-sm); flex-wrap: wrap; }
    .lista-item .nome { font-weight: 500; }
    .badge { display: inline-block; padding: 3px 8px; border-radius: var(--radius-sm); font-size: 11px; font-weight: 600; text-transform: uppercase; }
    .badge-mensalista { background: rgba(59,130,246,0.2); color: #60a5fa; }
    .badge-avulso { background: rgba(255,107,0,0.2); color: var(--accent); }
    .badge-masculino { background: rgba(59,130,246,0.15); color: #60a5fa; }
    .badge-feminino { background: rgba(236,100,155,0.15); color: #ff6b9d; }
    .btn-remove { padding: 8px 12px; background: rgba(239,68,68,0.15); border: 1px solid rgba(239,68,68,0.2); border-radius: var(--radius-sm); color: var(--danger); font-size: 12px; cursor: pointer; transition: all 0.2s; }
    .btn-remove:hover { background: rgba(239,68,68,0.25); }
    
    .times-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-md); }
    .time-card { background: rgba(255,255,255,0.02); border-radius: var(--radius-md); padding: var(--spacing-md); border: 1px solid rgba(255,255,255,0.05); }
    .time-card h4 { color: var(--accent); font-size: 15px; margin-bottom: var(--spacing-sm); padding-bottom: var(--spacing-sm); border-bottom: 1px solid rgba(255,255,255,0.05); }
    .time-card ul { list-style: none; }
    .time-card li { font-size: 14px; padding: 6px 0; color: var(--text-muted); display: flex; align-items: center; gap: 8px; }
    .time-card li.draggable { cursor: grab; padding: 8px 10px; margin: 4px 0; background: rgba(255,255,255,0.03); border-radius: var(--radius-sm); border: 1px solid transparent; transition: all 0.2s; }
    .time-card li.draggable:hover { background: rgba(255,107,0,0.1); border-color: rgba(255,107,0,0.3); }
    .time-card li.dragging { opacity: 0.5; cursor: grabbing; }
    .time-card li.drag-over { border-color: var(--accent); background: rgba(255,107,0,0.2); }
    .time-card ul.drag-target { min-height: 100px; }
    .admin-hint { font-size: 12px; color: var(--text-muted); text-align: center; margin-top: 12px; padding: 8px; background: rgba(255,107,0,0.1); border-radius: var(--radius-sm); }
    .btn-whatsapp { background: rgba(37,211,102,0.15); border: 1px solid rgba(37,211,102,0.3); color: #25d366; }
    .btn-whatsapp:hover { background: rgba(37,211,102,0.25); }
    
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-md); margin-bottom: var(--spacing-lg); }
    .stat-card { background: rgba(255,255,255,0.02); border-radius: var(--radius-md); padding: var(--spacing-lg); text-align: center; border: 1px solid rgba(255,255,255,0.05); }
    .stat-value { font-size: 36px; font-weight: 700; color: var(--accent); }
    .stat-label { font-size: 13px; color: var(--text-muted); margin-top: var(--spacing-xs); }
    .ranking-list { list-style: none; }
    .ranking-item { display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.03); transition: background 0.2s; }
    .ranking-item:hover { background: rgba(255,255,255,0.02); }
    .ranking-item .ranking-left { display: flex; align-items: center; }
    .ranking-item .pos { width: 30px; height: 30px; background: rgba(255,107,0,0.15); color: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 13px; margin-right: var(--spacing-md); }
    .ranking-item .pos.top-3 { background: var(--accent); color: #000; }
    .ranking-item .ranking-right { display: flex; align-items: center; gap: var(--spacing-md); }
    .ranking-item .count { color: var(--text-muted); font-size: 14px; }
    .empty-state { text-align: center; padding: var(--spacing-xl); color: var(--text-muted); }
    
    .mensagem { text-align: center; padding: var(--spacing-md); margin-bottom: var(--spacing-md); border-radius: var(--radius-md); font-size: 14px; min-height: 20px; }
    .mensagem.sucesso { background: rgba(52,211,153,0.1); color: #34d399; }
    .mensagem.erro { background: rgba(239,68,68,0.1); color: var(--danger); }
    
    .bottom-nav { display: none; position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-secondary); border-top: 1px solid rgba(255,255,255,0.05); padding: var(--spacing-sm) 0; z-index: 1000; }
    .bottom-nav-items { display: flex; justify-content: space-around; align-items: center; }
    .bottom-nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 8px 16px; color: var(--text-muted); text-decoration: none; font-size: 11px; font-weight: 500; border: none; background: transparent; cursor: pointer; transition: color 0.2s; }
    .bottom-nav-item .icon { font-size: 22px; }
    .bottom-nav-item.active { color: var(--accent); }
    
    @media (max-width: 768px) {
      .sidebar { display: none; }
      .main-content { margin-left: 0; padding: var(--spacing-md); padding-bottom: 100px; }
      .bottom-nav { display: block; }
      .page-title { font-size: 22px; }
      .times-grid { grid-template-columns: 1fr; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <aside class="sidebar">
      <div class="sidebar-logo">
        <span class="part1">PAGOU</span>
        <span class="part2">JOGOU</span>
      </div>
      <nav class="sidebar-nav">
        <button class="nav-item active" data-page="confirmados">
          <span class="icon">üìã</span>
          <span>Confirmados</span>
        </button>
        <button class="nav-item" data-page="sorteio">
          <span class="icon">üé≤</span>
          <span>Sorteio</span>
        </button>
        <button class="nav-item" data-page="estatisticas">
          <span class="icon">üìä</span>
          <span>Estat√≠sticas</span>
        </button>
      </nav>
      <div class="sidebar-admin">
        <button class="nav-item" onclick="fazerLogout()">
          <span class="icon">üö™</span>
          <span>Sair</span>
        </button>
      </div>
    </aside>
    
    <main class="main-content">
      <section id="page-confirmados" class="page active">
        <div class="page-header">
          <h1 class="page-title">Lista de Presen√ßa</h1>
          <p class="page-subtitle">Confirme sua presen√ßa para o v√¥lei!</p>
          <div id="userInfo" class="user-info"></div>
        </div>
        <div class="card">
          <h3 class="card-title">Nova Confirma√ß√£o</h3>
          <form id="formConfirma">
            <div class="form-group">
              <label class="form-label">Nome</label>
              <input type="text" id="nome" placeholder="Digite seu nome" required>
            </div>
            <div class="form-group">
              <label class="form-label">G√™nero</label>
              <select id="genero" required>
                <option value="">Selecione</option>
                <option value="masculino">Masculino</option>
                <option value="feminino">Feminino</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Tipo</label>
              <select id="tipo" required>
                <option value="">Selecione</option>
                <option value="mensalista">Mensalista</option>
                <option value="avulso">Avulso</option>
              </select>
            </div>
            <button class="btn btn-primary btn-block" type="submit">Confirmar Presen√ßa</button>
          </form>
        </div>
        <div id="mensagem" class="mensagem"></div>
        <div class="card">
          <h3 class="card-title">Confirmados <span class="contador-badge" id="contadorConfirmados">0</span></h3>
          <button class="btn btn-danger" id="limparConfirmados" style="margin-bottom: 16px;">Limpar Lista</button>
          <ul class="lista-confirmados" id="listaConfirmados"></ul>
        </div>
      </section>
      
      <section id="page-sorteio" class="page">
        <div class="page-header">
          <h1 class="page-title">Sorteio de Times</h1>
          <p class="page-subtitle">Distribua os jogadores em times equilibrados</p>
        </div>
        <div class="card">
          <h3 class="card-title">Realizar Sorteio</h3>
          <p style="color: var(--text-muted); margin-bottom: 16px; font-size: 14px;">
            O sorteio distribui automaticamente os jogadores em 3 ou 4 times, equilibrando homens e mulheres.
          </p>
          <div style="display: flex; gap: 12px;">
            <button class="btn btn-primary" style="flex:1;" id="sortearTimes">Sortear Times</button>
            <button class="btn btn-danger" id="limparSorteio" style="display:none;">Limpar</button>
          </div>
        </div>
        <div id="resultadoSorteio"></div>
      </section>
      
      <section id="page-estatisticas" class="page">
        <div class="page-header">
          <h1 class="page-title">Estat√≠sticas</h1>
          <p class="page-subtitle">Acompanhe as presen√ßas ao longo do tempo</p>
        </div>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="statTotal">0</div>
            <div class="stat-label">Total de Presen√ßas</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statJogadores">0</div>
            <div class="stat-label">Jogadores √önicos</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statMensalistas">0</div>
            <div class="stat-label">Mensalistas</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statAvulsos">0</div>
            <div class="stat-label">Avulsos</div>
          </div>
        </div>
        <div class="card">
          <h3 class="card-title">Ranking de Presen√ßas</h3>
          <ul class="ranking-list" id="rankingList"></ul>
          <div class="empty-state" id="emptyRanking" style="display:none;">
            Nenhum dado de estat√≠sticas dispon√≠vel.
          </div>
        </div>
      </section>
    </main>
  </div>

  <nav class="bottom-nav">
    <div class="bottom-nav-items">
      <button class="bottom-nav-item active" data-page="confirmados">
        <span class="icon">üìã</span>
        <span>Confirmados</span>
      </button>
      <button class="bottom-nav-item" data-page="sorteio">
        <span class="icon">üé≤</span>
        <span>Sorteio</span>
      </button>
      <button class="bottom-nav-item" data-page="estatisticas">
        <span class="icon">üìä</span>
        <span>Estat√≠sticas</span>
      </button>
      <button class="bottom-nav-item" onclick="fazerLogout()">
        <span class="icon">üö™</span>
        <span>Sair</span>
      </button>
    </div>
  </nav>

  <script>
    let currentTenantId = null;
    let adminToken = null;
    let isAdmin = false;
    
    // VERIFICA√á√ÉO DE TOKEN AO CARREGAR
    async function verificarTokenInicial() {
      const token = localStorage.getItem('adminToken');
      
      if (!token) {
        window.location.href = '/login.html';
        return false;
      }
      
      try {
        const response = await fetch('/verificar-token', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const result = await response.json();
        
        if (!result.valido) {
          localStorage.removeItem('adminToken');
          localStorage.removeItem('lastTenantId');
          window.location.href = '/login.html';
          return false;
        }
        
        const lastTenantId = localStorage.getItem('lastTenantId');
        currentTenantId = result.tenant_id;
        
        if (lastTenantId && lastTenantId !== String(currentTenantId)) {
          console.log('üîÑ Tenant diferente detectado. Limpando cache...');
          window.ultimoSorteio = null;
          if (document.getElementById('resultadoSorteio')) {
            document.getElementById('resultadoSorteio').innerHTML = '';
          }
        }
        
        localStorage.setItem('lastTenantId', currentTenantId || '');
        
        if (result.tenant_nome) {
          const userInfoEl = document.getElementById('userInfo');
          if (userInfoEl) {
            userInfoEl.textContent = `üìç ${result.tenant_nome}`;
          }
        }
        
        return true;
      } catch (err) {
        console.error('Erro ao verificar token:', err);
        localStorage.removeItem('adminToken');
        localStorage.removeItem('lastTenantId');
        window.location.href = '/login.html';
        return false;
      }
    }

    function getToken() {
      return localStorage.getItem('adminToken');
    }

    function handleUnauthorized() {
      alert('Sess√£o expirada. Fa√ßa login novamente.');
      localStorage.removeItem('adminToken');
      localStorage.removeItem('lastTenantId');
      window.location.href = '/login.html';
    }

    // NAVEGA√á√ÉO
    const navItems = document.querySelectorAll('[data-page]');
    const pages = document.querySelectorAll('.page');
    
    function navigateTo(pageId) {
      pages.forEach(p => p.classList.remove('active'));
      document.getElementById(`page-${pageId}`).classList.add('active');
      navItems.forEach(item => item.classList.toggle('active', item.dataset.page === pageId));
      if (pageId === 'estatisticas') carregarEstatisticas();
    }
    
    navItems.forEach(item => item.addEventListener('click', () => navigateTo(item.dataset.page)));
    
    // MENSAGEM
    function mostrarMensagem(texto, tipo = '') {
      const el = document.getElementById('mensagem');
      el.textContent = texto;
      el.className = `mensagem ${tipo}`;
      setTimeout(() => { el.textContent = ''; el.className = 'mensagem'; }, 3000);
    }
    
    // ATUALIZAR LISTA
    async function atualizarLista() {
      try {
        const token = getToken();
        
        const response = await fetch('/confirmados', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.status === 401) {
          handleUnauthorized();
          return;
        }
        
        const confirmados = await response.json();
        const lista = document.getElementById('listaConfirmados');
        const contador = document.getElementById('contadorConfirmados');
        
        contador.textContent = confirmados.length;
        lista.innerHTML = '';
        
        if (confirmados.length === 0) {
          lista.innerHTML = '<li class="empty-state">Nenhuma confirma√ß√£o ainda.</li>';
          return;
        }
        
        confirmados.forEach(c => {
          const li = document.createElement('li');
          li.className = `lista-item ${c.tipo === 'avulso' ? 'avulso' : ''}`;
          
          li.innerHTML = `
            <div class="info">
              <span class="nome">${c.nome}</span>
              <span class="badge badge-${c.tipo}">${c.tipo}</span>
              <span class="badge badge-${c.genero}">${c.genero === 'masculino' ? '‚ôÇ' : '‚ôÄ'}</span>
            </div>
            <button class="btn-remove" onclick="removerConfirmado(${c.id})">‚úï</button>
          `;
          
          lista.appendChild(li);
        });
      } catch (error) {
        console.error('Erro ao carregar lista:', error);
        mostrarMensagem('Erro ao carregar lista', 'erro');
      }
    }
    
    // REMOVER CONFIRMADO
    async function removerConfirmado(id) {
      if (!confirm('Remover esta pessoa?')) return;
      
      try {
        const token = getToken();
        
        const res = await fetch(`/confirmados/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (res.status === 401) {
          handleUnauthorized();
          return;
        }
        
        const data = await res.json();
        
        if (data.sucesso) {
          mostrarMensagem('Removido com sucesso!', 'sucesso');
          atualizarLista();
        } else {
          mostrarMensagem(data.erro || 'Erro ao remover.', 'erro');
        }
      } catch (err) {
        mostrarMensagem('Erro de conex√£o.', 'erro');
      }
    }
    
    // FORM CONFIRMA√á√ÉO
    document.getElementById('formConfirma').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const nome = document.getElementById('nome').value.trim();
      const tipo = document.getElementById('tipo').value;
      const genero = document.getElementById('genero').value;
      
      if (!nome || !tipo || !genero) return;
      
      try {
        const token = getToken();
        
        const res = await fetch('/confirmar', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ nome, tipo, genero })
        });
        
        if (res.status === 401) {
          handleUnauthorized();
          return;
        }
        
        const data = await res.json();
        
        if (res.ok) {
          mostrarMensagem('Presen√ßa confirmada!', 'sucesso');
          this.reset();
          atualizarLista();
        } else {
          throw new Error(data.erro || 'Erro ao confirmar.');
        }
      } catch (err) {
        mostrarMensagem(err.message || 'Erro ao confirmar.', 'erro');
      }
    });
    
    // SORTEIO
    function sortearTimes(confirmados) {
      confirmados = JSON.parse(JSON.stringify(confirmados));
      
      confirmados.forEach(c => {
        if (!c.genero) c.genero = 'masculino';
      });
      
      const homens = confirmados.filter(c => c.genero === 'masculino');
      const mulheres = confirmados.filter(c => c.genero === 'feminino');
      
      function shuffle(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
      }
      
      shuffle(homens);
      shuffle(mulheres);
      
      const totalPessoas = confirmados.length;
      const numTimes = totalPessoas <= 18 ? 3 : 4;
      
      const times = [];
      for (let i = 0; i < numTimes; i++) {
        times.push([]);
      }
      
      let timeIndex = 0;
      for (let i = 0; i < mulheres.length; i++) {
        times[timeIndex].push(mulheres[i]);
        timeIndex = (timeIndex + 1) % numTimes;
      }
      
      for (let i = 0; i < homens.length; i++) {
        let menorTime = 0;
        let menorTamanho = times[0].length;
        
        for (let t = 1; t < numTimes; t++) {
          if (times[t].length < menorTamanho) {
            menorTamanho = times[t].length;
            menorTime = t;
          }
        }
        
        times[menorTime].push(homens[i]);
      }
      
      const maxSize = Math.max(...times.map(t => t.length));
      for (let i = 0; i < numTimes; i++) {
        while (times[i].length < maxSize) {
          times[i].push({nome: 'Vaga Livre', genero: '', tipo: ''});
        }
      }
      
      return times;
    }
    
    // RENDER TIMES
    function renderizarTimes() {
      if (!window.ultimoSorteio) return;
      
      const times = window.ultimoSorteio;
      const numTimes = times.length;
      
      let html = '<div class="card">';
      html += '<h3 class="card-title">Times Sorteados</h3>';
      html += '<div class="times-grid">';
      
      for (let i = 0; i < numTimes; i++) {
        html += `<div class="time-card" data-time="${i}">`;
        html += `<h4>Time ${i + 1}</h4>`;
        html += `<ul data-time="${i}">`;
        
        times[i].forEach((p, j) => {
          const badge = p.genero ? `<span class="badge badge-${p.genero}">${p.genero === 'masculino' ? '‚ôÇ' : '‚ôÄ'}</span>` : '';
          html += `<li>${p.nome} ${badge}</li>`;
        });
        
        html += '</ul>';
        html += '</div>';
      }
      
      html += '</div>';
      html += '<button class="btn btn-whatsapp btn-block" style="margin-top:16px" onclick="compartilharWhatsApp()">üì± Compartilhar no WhatsApp</button>';
      html += '</div>';
      
      document.getElementById('resultadoSorteio').innerHTML = html;
    }
    
    // BOT√ÉO SORTEAR
    document.getElementById('sortearTimes').addEventListener('click', async function(e) {
      e.preventDefault();
      
      try {
        const token = getToken();
        
        const res = await fetch('/confirmados', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (res.status === 401) {
          handleUnauthorized();
          return;
        }
        
        const data = await res.json();
        const list = Array.isArray(data) ? data : (data.confirmed || []);
        const times = sortearTimes(list);
        window.ultimoSorteio = times;
        document.getElementById('limparSorteio').style.display = 'inline-block';
        renderizarTimes();
      } catch (err) {
        console.error('Erro sorteio:', err);
        mostrarMensagem('Erro ao sortear times', 'erro');
      }
    });
    
    // LIMPAR SORTEIO
    document.getElementById('limparSorteio').addEventListener('click', function() {
      document.getElementById('resultadoSorteio').innerHTML = '';
      this.style.display = 'none';
      window.ultimoSorteio = null;
    });
    
    // WHATSAPP
    function compartilharWhatsApp() {
      if (!window.ultimoSorteio) return;
      
      const numTimes = window.ultimoSorteio.length;
      let mensagem = 'üèê *SORTEIO DOS TIMES - V√îLEI SEXTA*\n\n';
      
      for (let i = 0; i < numTimes; i++) {
        mensagem += `*Time ${i + 1}*\n`;
        window.ultimoSorteio[i].forEach(p => {
          if (p.nome !== 'Vaga Livre') {
            mensagem += `${p.nome}${p.genero ? ' ' + (p.genero === 'masculino' ? '‚ôÇ' : '‚ôÄ') : ''}\n`;
          }
        });
        mensagem += '\n';
      }
      
      window.open(`https://wa.me/5511986439388?text=${encodeURIComponent(mensagem)}`, '_blank');
    }
    
    // LIMPAR LISTA
    document.getElementById('limparConfirmados').addEventListener('click', async function(e) {
      e.preventDefault();
      
      if (confirm('Limpar todos os confirmados?')) {
        try {
          const token = getToken();
          
          const res = await fetch('/confirmados', {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
          });
          
          if (res.status === 401) {
            handleUnauthorized();
            return;
          }
          
          const data = await res.json();
          
          if (data.sucesso) {
            mostrarMensagem('Lista limpa!', 'sucesso');
            atualizarLista();
          }
        } catch (err) {
          mostrarMensagem('Erro ao limpar.', 'erro');
        }
      }
    });
    
    // LOGOUT
    async function fazerLogout() {
      const token = getToken();
      
      if (token) {
        try {
          await fetch('/logout', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            }
          });
        } catch (e) {
          console.log('Erro ao fazer logout:', e);
        }
      }
      
      localStorage.removeItem('adminToken');
      localStorage.removeItem('lastTenantId');
      window.location.href = '/login.html';
    }
    
    // ESTAT√çSTICAS
    async function carregarEstatisticas() {
      try {
        const token = getToken();
        
        const res = await fetch('/estatisticas', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (res.status === 401) {
          handleUnauthorized();
          return;
        }
        
        if (!res.ok) throw new Error(`Erro HTTP: ${res.status}`);
        
        const data = await res.json();
        const ranking = data.ranking || [];
        const resumo = data.resumo || {};
        
        if (ranking.length === 0) {
          document.getElementById('rankingList').style.display = 'none';
          document.getElementById('emptyRanking').style.display = 'block';
          document.getElementById('statTotal').textContent = '0';
          document.getElementById('statJogadores').textContent = '0';
          document.getElementById('statMensalistas').textContent = '0';
          document.getElementById('statAvulsos').textContent = '0';
          return;
        }
        
        document.getElementById('rankingList').style.display = 'block';
        document.getElementById('emptyRanking').style.display = 'none';
        
        document.getElementById('statTotal').textContent = resumo.totalConfirmacoes || 0;
        document.getElementById('statJogadores').textContent = resumo.pessoasUnicas || 0;
        
        const mensalistas = ranking.filter(r => r.tipo === 'mensalista').length;
        const avulsos = ranking.filter(r => r.tipo === 'avulso').length;
        document.getElementById('statMensalistas').textContent = mensalistas;
        document.getElementById('statAvulsos').textContent = avulsos;
        
        const ul = document.getElementById('rankingList');
        ul.innerHTML = '';
        
        ranking.forEach((r, i) => {
          const li = document.createElement('li');
          li.className = 'ranking-item';
          const presencas = parseInt(r.total_confirmacoes || 0, 10);
          
          const leftDiv = document.createElement('div');
          leftDiv.className = 'ranking-left';
          leftDiv.innerHTML = `<span class="pos ${i < 3 ? 'top-3' : ''}">${i + 1}</span><span>${r.nome}</span>`;
          
          const rightDiv = document.createElement('div');
          rightDiv.className = 'ranking-right';
          
          const countSpan = document.createElement('span');
          countSpan.className = 'count';
          countSpan.textContent = `${presencas} presen√ßas`;
          rightDiv.appendChild(countSpan);
          
          li.appendChild(leftDiv);
          li.appendChild(rightDiv);
          ul.appendChild(li);
        });
      } catch (err) {
        console.error('Erro ao carregar estat√≠sticas:', err);
        document.getElementById('rankingList').style.display = 'none';
        document.getElementById('emptyRanking').style.display = 'block';
        document.getElementById('emptyRanking').textContent = 'Erro ao carregar estat√≠sticas.';
      }
    }
    
    // INICIALIZA√á√ÉO
    verificarTokenInicial().then(valido => {
      if (valido) {
        atualizarLista();
      }
    });
  </script>
</body>
</html>
