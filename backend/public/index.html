<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pagou-Jogou V√¥lei Clube</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #000000;
      --bg-secondary: #111111;
      --bg-card: #1a1a1a;
      --text-primary: #ffffff;
      --text-muted: #888888;
      --accent: #ff6b00;
      --accent-light: #ff8533;
      --accent-dark: #cc5500;
      --danger: #ef4444;
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
      --spacing-xl: 32px;
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 16px;
      --sidebar-width: 240px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: Inter, system-ui, Arial, sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }
    
    /* LAYOUT */
    .app-container { display: flex; min-height: 100vh; }
    .sidebar { width: var(--sidebar-width); background: var(--bg-secondary); border-right: 1px solid rgba(255,255,255,0.05); padding: var(--spacing-lg); display: flex; flex-direction: column; position: fixed; height: 100vh; left: 0; top: 0; }
    .sidebar-logo { display: flex; align-items: baseline; gap: 4px; font-weight: 700; letter-spacing: 1px; font-size: 18px; margin-bottom: var(--spacing-xl); padding-bottom: var(--spacing-lg); border-bottom: 1px solid rgba(255,255,255,0.05); }
    .sidebar-logo .part1 { color: var(--text-primary); }
    .sidebar-logo .part2 { color: var(--accent); }
    .sidebar-nav { display: flex; flex-direction: column; gap: var(--spacing-sm); flex: 1; }
    .nav-item { display: flex; align-items: center; gap: var(--spacing-md); padding: 14px 16px; border-radius: var(--radius-md); color: var(--text-muted); text-decoration: none; font-size: 14px; font-weight: 500; transition: all 0.2s; cursor: pointer; border: none; background: transparent; width: 100%; text-align: left; }
    .nav-item:hover { background: rgba(255, 107, 0, 0.1); color: var(--text-primary); }
    .nav-item.active { background: rgba(255, 107, 0, 0.15); color: var(--accent); border-left: 3px solid var(--accent); }
    .sidebar-admin { border-top: 1px solid rgba(255,255,255,0.05); padding-top: var(--spacing-md); margin-top: auto; }
    .nav-item.admin-logged { color: var(--accent); }
    
    .main-content { flex: 1; margin-left: var(--sidebar-width); padding: var(--spacing-xl); min-height: 100vh; }
    .page { display: none; max-width: 800px; margin: 0 auto; }
    .page.active { display: block; }
    .page-header { margin-bottom: var(--spacing-xl); }
    .page-title { font-size: 28px; font-weight: 700; color: var(--text-primary); margin-bottom: var(--spacing-xs); }
    .page-subtitle { color: var(--text-muted); font-size: 14px; }
    
    /* CARDS & FORM */
    .card { background: var(--bg-card); border-radius: var(--radius-lg); padding: var(--spacing-lg); margin-bottom: var(--spacing-lg); border: 1px solid rgba(255,255,255,0.05); }
    .card-title { font-size: 16px; font-weight: 600; margin-bottom: var(--spacing-md); display: flex; align-items: center; gap: var(--spacing-sm); }
    .form-group { margin-bottom: var(--spacing-md); }
    .form-label { display: block; font-size: 13px; color: var(--text-muted); margin-bottom: var(--spacing-xs); }
    input, select { width: 100%; height: 48px; padding: 12px 14px; border-radius: var(--radius-md); border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.03); color: var(--text-primary); font-size: 15px; transition: border-color 0.2s; }
    input:focus, select:focus { outline: none; border-color: var(--accent); }
    
    /* BOT√ïES */
    .btn { height: 48px; padding: 12px 20px; border-radius: var(--radius-md); border: none; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: var(--spacing-sm); }
    .btn-primary { background: linear-gradient(135deg, var(--accent), var(--accent-dark)); color: #000; }
    .btn-primary:hover { background: linear-gradient(135deg, var(--accent-light), var(--accent)); transform: translateY(-1px); }
    .btn-secondary { background: rgba(255,107,0,0.15); border: 1px solid rgba(255,107,0,0.3); color: var(--accent); }
    .btn-secondary:hover { background: rgba(255,107,0,0.25); }
    .btn-danger { background: rgba(239,68,68,0.15); border: 1px solid rgba(239,68,68,0.3); color: var(--danger); }
    .btn-danger:hover { background: rgba(239,68,68,0.25); }
    .btn-block { width: 100%; }
    
    /* LISTA CONFIRMADOS */
    .contador-badge { background: rgba(255,107,0,0.2); color: var(--accent); padding: 4px 10px; border-radius: var(--radius-sm); font-size: 13px; font-weight: 600; }
    .lista-confirmados { list-style: none; }
    .lista-item { display: flex; align-items: center; justify-content: space-between; padding: 14px 12px; border-bottom: 1px solid rgba(255,255,255,0.03); transition: background 0.2s; }
    .lista-item:hover { background: rgba(255,255,255,0.02); }
    .lista-item.avulso { border-left: 3px solid var(--accent); background: rgba(255,107,0,0.03); }
    .lista-item .info { display: flex; align-items: center; gap: var(--spacing-sm); flex-wrap: wrap; }
    .lista-item .nome { font-weight: 500; }
    .badge { display: inline-block; padding: 3px 8px; border-radius: var(--radius-sm); font-size: 11px; font-weight: 600; text-transform: uppercase; }
    .badge-mensalista { background: rgba(59,130,246,0.2); color: #60a5fa; }
    .badge-avulso { background: rgba(255,107,0,0.2); color: var(--accent); }
    .badge-masculino { background: rgba(59,130,246,0.15); color: #60a5fa; }
    .badge-feminino { background: rgba(236,100,155,0.15); color: #ff6b9d; }
    .btn-remove { padding: 8px 12px; background: rgba(239,68,68,0.15); border: 1px solid rgba(239,68,68,0.2); border-radius: var(--radius-sm); color: var(--danger); font-size: 12px; cursor: pointer; transition: all 0.2s; }
    .btn-remove:hover { background: rgba(239,68,68,0.25); }
    
    /* TIMES */
    .times-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-md); }
    .time-card { background: rgba(255,255,255,0.02); border-radius: var(--radius-md); padding: var(--spacing-md); border: 1px solid rgba(255,255,255,0.05); }
    .time-card h4 { color: var(--accent); font-size: 15px; margin-bottom: var(--spacing-sm); padding-bottom: var(--spacing-sm); border-bottom: 1px solid rgba(255,255,255,0.05); }
    .time-card ul { list-style: none; }
    .time-card li { font-size: 14px; padding: 6px 0; color: var(--text-muted); display: flex; align-items: center; gap: 8px; }
    
    /* DRAG AND DROP ADMIN */
    .time-card li.draggable { cursor: grab; padding: 8px 10px; margin: 4px 0; background: rgba(255,255,255,0.03); border-radius: var(--radius-sm); border: 1px solid transparent; transition: all 0.2s; }
    .time-card li.draggable:hover { background: rgba(255,107,0,0.1); border-color: rgba(255,107,0,0.3); }
    .time-card li.dragging { opacity: 0.5; cursor: grabbing; }
    .time-card li.drag-over { border-color: var(--accent); background: rgba(255,107,0,0.2); }
    .time-card ul.drag-target { min-height: 100px; }
    .admin-hint { font-size: 12px; color: var(--text-muted); text-align: center; margin-top: 12px; padding: 8px; background: rgba(255,107,0,0.1); border-radius: var(--radius-sm); }
    
    .btn-whatsapp { background: rgba(37,211,102,0.15); border: 1px solid rgba(37,211,102,0.3); color: #25d366; }
    .btn-whatsapp:hover { background: rgba(37,211,102,0.25); }
    
    /* ESTAT√çSTICAS */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-md); margin-bottom: var(--spacing-lg); }
    .stat-card { background: rgba(255,255,255,0.02); border-radius: var(--radius-md); padding: var(--spacing-lg); text-align: center; border: 1px solid rgba(255,255,255,0.05); }
    .stat-value { font-size: 36px; font-weight: 700; color: var(--accent); }
    .stat-label { font-size: 13px; color: var(--text-muted); margin-top: var(--spacing-xs); }
    .ranking-list { list-style: none; }
    .ranking-item { display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.03); }
    .ranking-item .pos { width: 30px; height: 30px; background: rgba(255,107,0,0.15); color: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 13px; margin-right: var(--spacing-md); }
    .ranking-item .pos.top-3 { background: var(--accent); color: #000; }
    .ranking-item .count { color: var(--text-muted); font-size: 14px; }
    
    /* MODAL LOGIN */
    .login-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center; }
    .login-modal.ativo { display: flex; }
    .login-box { background: var(--bg-card); border-radius: var(--radius-lg); padding: 30px; max-width: 350px; width: 90%; border: 1px solid rgba(255,107,0,0.3); }
    .login-box h3 { color: var(--accent); margin-bottom: 20px; text-align: center; }
    .login-box input { width: 100%; margin-bottom: 12px; }
    .login-erro { color: var(--danger); font-size: 13px; margin-bottom: 12px; text-align: center; display: none; }
    
    /* MENSAGEM */
    .mensagem { text-align: center; padding: var(--spacing-md); margin-bottom: var(--spacing-md); border-radius: var(--radius-md); font-size: 14px; min-height: 20px; }
    .mensagem.sucesso { background: rgba(52,211,153,0.1); color: #34d399; }
    .mensagem.erro { background: rgba(239,68,68,0.1); color: var(--danger); }
    
    /* BOTTOM NAV MOBILE */
    .bottom-nav { display: none; position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-secondary); border-top: 1px solid rgba(255,255,255,0.05); padding: var(--spacing-sm) 0; z-index: 1000; }
    .bottom-nav-items { display: flex; justify-content: space-around; align-items: center; }
    .bottom-nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 8px 16px; color: var(--text-muted); text-decoration: none; font-size: 11px; font-weight: 500; border: none; background: transparent; cursor: pointer; transition: color 0.2s; }
    .bottom-nav-item .icon { font-size: 22px; }
    .bottom-nav-item.active { color: var(--accent); }
    .bottom-nav-item.admin-logged { color: var(--accent); }
    
    /* RESPONSIVO */
    @media (max-width: 768px) {
      .sidebar { display: none; }
      .main-content { margin-left: 0; padding: var(--spacing-md); padding-bottom: 100px; }
      .bottom-nav { display: block; }
      .page-title { font-size: 22px; }
      .times-grid { grid-template-columns: 1fr; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar Desktop -->
    <aside class="sidebar">
      <div class="sidebar-logo">
        <span class="part1">PAGOU</span>
        <span class="part2">JOGOU</span>
      </div>
      <nav class="sidebar-nav">
        <button class="nav-item active" data-page="confirmados">
          <span class="icon">üìã</span>
          <span>Confirmados</span>
        </button>
        <button class="nav-item" data-page="sorteio">
          <span class="icon">üé≤</span>
          <span>Sorteio</span>
        </button>
        <button class="nav-item" data-page="estatisticas">
          <span class="icon">üìä</span>
          <span>Estat√≠sticas</span>
        </button>
      </nav>
      <div class="sidebar-admin">
        <button class="nav-item" id="btnAdminSidebar" onclick="abrirLogin()">
          <span class="icon">üîê</span>
          <span>Admin</span>
        </button>
        <button class="nav-item admin-logged" id="btnLogoutSidebar" onclick="fazerLogout()" style="display:none;">
          <span class="icon">üö™</span>
          <span>Sair</span>
        </button>
      </div>
    </aside>
    
    <!-- Main Content -->
    <main class="main-content">
      <!-- P√°gina Confirmados -->
      <section id="page-confirmados" class="page active">
        <div class="page-header">
          <h1 class="page-title">Lista de Presen√ßa</h1>
          <p class="page-subtitle">Confirme sua presen√ßa para o v√¥lei!</p>
        </div>
        <div class="card">
          <h3 class="card-title">Nova Confirma√ß√£o</h3>
          <form id="formConfirma">
            <div class="form-group">
              <label class="form-label">Nome</label>
              <input type="text" id="nome" placeholder="Digite seu nome" required>
            </div>
            <div class="form-group">
              <label class="form-label">G√™nero</label>
              <select id="genero" required>
                <option value="">Selecione</option>
                <option value="masculino">Masculino</option>
                <option value="feminino">Feminino</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Tipo</label>
              <select id="tipo" required>
                <option value="">Selecione</option>
                <option value="mensalista">Mensalista</option>
                <option value="avulso">Avulso</option>
              </select>
            </div>
            <button class="btn btn-primary btn-block" type="submit">Confirmar Presen√ßa</button>
          </form>
        </div>
        <div id="mensagem" class="mensagem"></div>
        <div class="card">
          <h3 class="card-title">Confirmados <span class="contador-badge" id="contadorConfirmados">0</span></h3>
          <button class="btn btn-danger" id="limparConfirmados" style="margin-bottom: 16px;">Limpar Lista</button>
          <ul class="lista-confirmados" id="listaConfirmados"></ul>
        </div>
      </section>
      
      <!-- P√°gina Sorteio -->
      <section id="page-sorteio" class="page">
        <div class="page-header">
          <h1 class="page-title">Sorteio de Times</h1>
          <p class="page-subtitle">Distribua os jogadores em times equilibrados</p>
        </div>
        <div class="card">
          <h3 class="card-title">Realizar Sorteio</h3>
          <p style="color: var(--text-muted); margin-bottom: 16px; font-size: 14px;">
            O sorteio distribui automaticamente os jogadores em 4 times, equilibrando homens e mulheres.
          </p>
          <div style="display: flex; gap: 12px;">
            <button class="btn btn-primary" style="flex:1;" id="sortearTimes">Sortear Times</button>
            <button class="btn btn-danger" id="limparSorteio" style="display:none;">Limpar</button>
          </div>
        </div>
        <div id="resultadoSorteio"></div>
      </section>
      
      <!-- P√°gina Estat√≠sticas -->
      <section id="page-estatisticas" class="page">
        <div class="page-header">
          <h1 class="page-title">Estat√≠sticas</h1>
          <p class="page-subtitle">Acompanhe as presen√ßas ao longo do tempo</p>
        </div>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="statTotal">0</div>
            <div class="stat-label">Total de Presen√ßas</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statJogadores">0</div>
            <div class="stat-label">Jogadores √önicos</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statMensalistas">0</div>
            <div class="stat-label">Mensalistas</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statAvulsos">0</div>
            <div class="stat-label">Avulsos</div>
          </div>
        </div>
        <div class="card">
          <h3 class="card-title">Ranking de Presen√ßas</h3>
          <ul class="ranking-list" id="rankingList"></ul>
        </div>
      </section>
    </main>
  </div>

  <!-- Bottom Nav Mobile -->
  <nav class="bottom-nav">
    <div class="bottom-nav-items">
      <button class="bottom-nav-item active" data-page="confirmados">
        <span class="icon">üìã</span>
        <span>Confirmados</span>
      </button>
      <button class="bottom-nav-item" data-page="sorteio">
        <span class="icon">üé≤</span>
        <span>Sorteio</span>
      </button>
      <button class="bottom-nav-item" data-page="estatisticas">
        <span class="icon">üìä</span>
        <span>Estat√≠sticas</span>
      </button>
      <button class="bottom-nav-item" id="btnAdminMobile" onclick="abrirLogin()">
        <span class="icon">üîê</span>
        <span>Admin</span>
      </button>
      <button class="bottom-nav-item admin-logged" id="btnLogoutMobile" onclick="fazerLogout()" style="display:none;">
        <span class="icon">üö™</span>
        <span>Sair</span>
      </button>
    </div>
  </nav>

  <!-- Modal Login Admin -->
  <div class="login-modal" id="loginModal">
    <div class="login-box">
      <h3>Login Admin</h3>
      <div class="login-erro" id="loginErro"></div>
      <input type="text" id="loginUsuario" placeholder="Usu√°rio">
      <input type="password" id="loginSenha" placeholder="Senha">
      <button class="btn btn-primary btn-block" onclick="fazerLogin()">Entrar</button>
      <button class="btn btn-secondary btn-block" onclick="fecharLogin()" style="margin-top:8px;">Cancelar</button>
    </div>
  </div>

  <script>
    // NAVEGA√á√ÉO
    const navItems = document.querySelectorAll('[data-page]');
    const pages = document.querySelectorAll('.page');
    function navigateTo(pageId) {
      pages.forEach(p => p.classList.remove('active'));
      document.getElementById(`page-${pageId}`).classList.add('active');
      navItems.forEach(item => item.classList.toggle('active', item.dataset.page === pageId));
      if (pageId === 'estatisticas') carregarEstatisticas();
    }
    navItems.forEach(item => item.addEventListener('click', () => navigateTo(item.dataset.page)));
    
    // MENSAGEM
    function mostrarMensagem(texto, tipo = '') {
      const el = document.getElementById('mensagem');
      el.textContent = texto;
      el.className = `mensagem ${tipo}`;
      setTimeout(() => { el.textContent = ''; el.className = 'mensagem'; }, 3000);
    }
    
    // ATUALIZAR LISTA (CAP 24)
    async function atualizarLista() {
      try {
        const res = await fetch('/confirmados');
        const data = await res.json();
        let confirmed = Array.isArray(data) ? data.slice(0, 24) : (data.confirmed || []).slice(0, 24);
        
        const contador = document.getElementById('contadorConfirmados');
        if (contador) contador.textContent = confirmed.length;
        
        const ul = document.getElementById('listaConfirmados');
        if (ul) {
          ul.innerHTML = '';
          confirmed.forEach((c, i) => {
            const li = document.createElement('li');
            li.className = `lista-item ${c.tipo === 'avulso' ? 'avulso' : ''}`;
            const info = document.createElement('div');
            info.className = 'info';
            const nome = document.createElement('span');
            nome.className = 'nome';
            nome.textContent = `${i + 1}. ${c.nome}`;
            info.appendChild(nome);
            const tipoBadge = document.createElement('span');
            tipoBadge.className = `badge badge-${c.tipo}`;
            tipoBadge.textContent = c.tipo === 'mensalista' ? 'M' : 'A';
            tipoBadge.title = c.tipo;
            info.appendChild(tipoBadge);
            if (c.genero) {
              const generoBadge = document.createElement('span');
              generoBadge.className = `badge badge-${c.genero}`;
              generoBadge.textContent = c.genero === 'masculino' ? '‚ôÇ' : '‚ôÄ';
              generoBadge.title = c.genero;
              info.appendChild(generoBadge);
            }
            li.appendChild(info);
            const btn = document.createElement('button');
            btn.className = 'btn-remove';
            btn.textContent = '‚úï';
            btn.title = `Remover ${c.nome}`;
            btn.addEventListener('click', () => removerConfirmado(c.id));
            li.appendChild(btn);
            ul.appendChild(li);
          });
        }
      } catch (err) {
        console.error('Erro lista:', err);
      }
    }
    
    // REMOVER CONFIRMADO
    async function removerConfirmado(id) {
      if (!confirm('Remover esta pessoa?')) return;
      try {
        const res = await fetch(`/confirmados/${id}`, { method: 'DELETE' });
        const data = await res.json();
        if (data.sucesso) {
          mostrarMensagem('Removido com sucesso!', 'sucesso');
          atualizarLista();
        } else {
          mostrarMensagem(data.erro || 'Erro ao remover.', 'erro');
        }
      } catch (err) {
        mostrarMensagem('Erro de conex√£o.', 'erro');
      }
    }
    
    // FORM CONFIRMA√á√ÉO
    document.getElementById('formConfirma').addEventListener('submit', async function(e) {
      e.preventDefault();
      const nome = document.getElementById('nome').value.trim();
      const tipo = document.getElementById('tipo').value;
      const genero = document.getElementById('genero').value;
      if (!nome || !tipo || !genero) return;
      
      try {
        const res = await fetch('/confirmar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nome, tipo, genero })
        });
        const data = await res.json();
        if (res.ok) {
          mostrarMensagem('Presen√ßa confirmada!', 'sucesso');
          this.reset();
          atualizarLista();
        } else {
          throw new Error(data.erro || 'Erro ao confirmar.');
        }
      } catch (err) {
        mostrarMensagem(err.message || 'Erro ao confirmar.', 'erro');
      }
    });
    
    // SORTEIO CORRIGIDO (24 max, 4x6 perfeitos, sem vaga extra se 24)
    function sortearTimes(confirmados) {
      const MAX_JOGADORES = 24;
      const NUM_TIMES = 4;
      const MAX_POR_TIME = 6;
      
      let jogadores = confirmados.slice(0, MAX_JOGADORES);
      jogadores.forEach(c => c.genero ||= 'masculino');
      
      const homens = jogadores.filter(c => c.genero === 'masculino');
      const mulheres = jogadores.filter(c => c.genero === 'feminino');
      
      function shuffle(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
      }
      shuffle([...homens]);
      shuffle([...mulheres]);
      
      // Intercala M-H
      const combinado = [];
      let mi = 0, hi = 0;
      while (mi < mulheres.length || hi < homens.length) {
        if (mi < mulheres.length) combinado.push(mulheres[mi++]);
        if (hi < homens.length) combinado.push(homens[hi++]);
      }
      
      // Round-robin perfeito
      const times = Array(NUM_TIMES).fill().map(() => []);
      combinado.forEach((jogador, idx) => {
        const timeIdx = idx % NUM_TIMES;
        if (times[timeIdx].length < MAX_POR_TIME) {
          times[timeIdx].push(jogador);
        }
      });
      
      // Vaga livre SOMENTE se <24
      if (confirmados.length < MAX_JOGADORES) {
        times.forEach(time => {
          while (time.length < MAX_POR_TIME) {
            time.push({ nome: 'Vaga Livre', genero: '', tipo: '' });
          }
        });
      }
      
      return times;
    }
    
    // RENDER TIMES COM DRAG AND DROP PARA ADMIN
    function renderizarTimes() {
      if (!window.ultimoSorteio) return;
      const times = window.ultimoSorteio;
      const canDrag = isAdmin;
      
      let html = '<div class="card"><h3 class="card-title">Times Sorteados</h3>';
      if (canDrag) {
        html += '<div class="admin-hint">üëÜ Arraste os jogadores para trocar de time</div>';
      }
      html += '<div class="times-grid">';
      
      for (let i = 0; i < 4; i++) {
        html += `<div class="time-card" data-time="${i}"><h4>Time ${i + 1}</h4><ul class="${canDrag ? 'drag-target' : ''}" data-time="${i}">`;
        times[i].forEach((p, j) => {
          const badge = p.genero ? `<span class="badge badge-${p.genero}">${p.genero === 'masculino' ? '‚ôÇ' : '‚ôÄ'}</span>` : '';
          if (canDrag && p.nome !== 'Vaga Livre') {
            html += `<li class="draggable" draggable="true" data-time="${i}" data-index="${j}">${p.nome}${badge}</li>`;
          } else {
            html += `<li>${p.nome}${badge}</li>`;
          }
        });
        html += '</ul></div>';
      }
      html += '</div>';
      html += '<button class="btn btn-whatsapp btn-block" style="margin-top:16px;" onclick="compartilharWhatsApp()">üì± Compartilhar no WhatsApp</button>';
      html += '</div>';
      document.getElementById('resultadoSorteio').innerHTML = html;
      
      if (canDrag) initDragAndDrop();
    }
    
    // DRAG AND DROP PARA ADMIN
    function initDragAndDrop() {
      let draggedItem = null;
      let draggedFromTime = null;
      let draggedIndex = null;
      
      document.querySelectorAll('.draggable').forEach(item => {
        item.addEventListener('dragstart', function(e) {
          draggedItem = this;
          draggedFromTime = parseInt(this.dataset.time);
          draggedIndex = parseInt(this.dataset.index);
          this.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
        });
        
        item.addEventListener('dragend', function() {
          this.classList.remove('dragging');
          document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        });
        
        item.addEventListener('dragover', function(e) {
          e.preventDefault();
          if (this !== draggedItem) {
            this.classList.add('drag-over');
          }
        });
        
        item.addEventListener('dragleave', function() {
          this.classList.remove('drag-over');
        });
        
        item.addEventListener('drop', function(e) {
          e.preventDefault();
          if (this === draggedItem) return;
          
          const targetTime = parseInt(this.dataset.time);
          const targetIndex = parseInt(this.dataset.index);
          
          // Trocar jogadores
          const temp = window.ultimoSorteio[draggedFromTime][draggedIndex];
          window.ultimoSorteio[draggedFromTime][draggedIndex] = window.ultimoSorteio[targetTime][targetIndex];
          window.ultimoSorteio[targetTime][targetIndex] = temp;
          
          renderizarTimes();
        });
      });
    }
    
    // BOT√ÉO SORTEAR
    document.getElementById('sortearTimes').addEventListener('click', async function(e) {
      e.preventDefault();
      try {
        const res = await fetch('/confirmados');
        const data = await res.json();
        const list = Array.isArray(data) ? data : (data.confirmed || []);
        const times = sortearTimes(list);
        window.ultimoSorteio = times;
        document.getElementById('limparSorteio').style.display = 'inline-block';
        renderizarTimes();
      } catch (err) {
        console.error('Erro sorteio:', err);
      }
    });
    
    // LIMPAR SORTEIO
    document.getElementById('limparSorteio').addEventListener('click', function() {
      document.getElementById('resultadoSorteio').innerHTML = '';
      this.style.display = 'none';
      window.ultimoSorteio = null;
    });
    
    // WHATSAPP
    function compartilharWhatsApp() {
      if (!window.ultimoSorteio) return;
      let mensagem = '*üèê SORTEIO DOS TIMES - V√îLEI SEXTA üèê*%0A%0A';
      for (let i = 0; i < 4; i++) {
        mensagem += `*Time ${i + 1}*%0A`;
        window.ultimoSorteio[i].forEach(p => {
          mensagem += `‚Ä¢ ${p.nome}${p.genero ? ' (' + p.genero + ')' : ''}%0A`;
        });
        mensagem += '%0A';
      }
      window.open(`https://wa.me/5511986439388?text=${mensagem}`, '_blank');
    }
    
    // LIMPAR LISTA
    document.getElementById('limparConfirmados').addEventListener('click', async function(e) {
      e.preventDefault();
      if (confirm('Limpar todos os confirmados?')) {
        try {
          const res = await fetch('/confirmados', { method: 'DELETE' });
          const data = await res.json();
          if (data.sucesso) {
            mostrarMensagem('Lista limpa!', 'sucesso');
            atualizarLista();
          }
        } catch (err) {
          mostrarMensagem('Erro ao limpar.', 'erro');
        }
      }
    });
    
    // SISTEMA ADMIN
    let adminToken = null;
    let isAdmin = false;
    
    function abrirLogin() {
      document.getElementById('loginModal').classList.add('ativo');
      document.getElementById('loginUsuario').focus();
    }
    
    function fecharLogin() {
      document.getElementById('loginModal').classList.remove('ativo');
      document.getElementById('loginUsuario').value = '';
      document.getElementById('loginSenha').value = '';
      document.getElementById('loginErro').style.display = 'none';
    }
    
    async function fazerLogin() {
      const usuario = document.getElementById('loginUsuario').value;
      const senha = document.getElementById('loginSenha').value;
      try {
        const res = await fetch('/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ usuario, senha })
        });
        const data = await res.json();
        if (data.sucesso) {
          adminToken = data.token;
          isAdmin = true;
          fecharLogin();
          atualizarUIAdmin();
          carregarEstatisticas();
          mostrarMensagem('Login realizado com sucesso!', 'sucesso');
        } else {
          document.getElementById('loginErro').textContent = data.erro || 'Credenciais inv√°lidas';
          document.getElementById('loginErro').style.display = 'block';
        }
      } catch (err) {
        document.getElementById('loginErro').textContent = 'Erro de conex√£o';
        document.getElementById('loginErro').style.display = 'block';
      }
    }
    
    async function fazerLogout() {
      if (adminToken) {
        try {
          await fetch('/logout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token: adminToken })
          });
        } catch (e) {}
      }
      adminToken = null;
      isAdmin = false;
      atualizarUIAdmin();
      carregarEstatisticas();
      mostrarMensagem('Logout realizado', 'sucesso');
    }
    
    function atualizarUIAdmin() {
      // Sidebar desktop
      document.getElementById('btnAdminSidebar').style.display = isAdmin ? 'none' : 'flex';
      document.getElementById('btnLogoutSidebar').style.display = isAdmin ? 'flex' : 'none';
      // Bottom nav mobile
      document.getElementById('btnAdminMobile').style.display = isAdmin ? 'none' : 'flex';
      document.getElementById('btnLogoutMobile').style.display = isAdmin ? 'flex' : 'none';
      // Re-renderiza times se existir sorteio ativo para ativar/desativar drag
      if (window.ultimoSorteio) renderizarTimes();
    }
    
    // ESTAT√çSTICAS
    function carregarEstatisticas() {
      fetch('/estatisticas')
        .then(res => res.json())
        .then(data => {
          const ranking = data.ranking || [];
          const total = ranking.reduce((sum, r) => sum + parseInt(r.totalconfirmacoes || 0, 10), 0);
          const mensalistas = ranking.filter(r => r.tipo === 'mensalista').length;
          const avulsos = ranking.filter(r => r.tipo === 'avulso').length;
          
          document.getElementById('statTotal').textContent = total;
          document.getElementById('statJogadores').textContent = ranking.length;
          document.getElementById('statMensalistas').textContent = mensalistas;
          document.getElementById('statAvulsos').textContent = avulsos;
          
          const ul = document.getElementById('rankingList');
          ul.innerHTML = '';
          ranking.forEach((r, i) => {
            const li = document.createElement('li');
            li.className = 'ranking-item';
            const presencas = parseInt(r.totalconfirmacoes || 0, 10);
            li.innerHTML = `<div style="display:flex;align-items:center;"><span class="pos ${i < 3 ? 'top-3' : ''}">${i + 1}</span><span>${r.nome}</span></div><span class="count">${presencas} presen√ßas</span>`;
            ul.appendChild(li);
          });
        })
        .catch(err => console.error('Erro estat√≠sticas:', err));
    }
    
    // INICIALIZA
    atualizarLista();
    atualizarUIAdmin();
  </script>
</body>
</html>
